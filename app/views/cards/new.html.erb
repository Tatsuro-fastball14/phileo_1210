<!-- app/views/cards/new.html.erb -->
<h1>カード登録</h1>
<form id="card-form">
  <div id="card-element"></div>
  <button id="submit-btn" type="submit">保存して購読開始</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  (async () => {
    const stripe = Stripe("<%= ENV.fetch('STRIPE_PUBLISHABLE_KEY') %>");
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    const form = document.getElementById('card-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // サーバで発行したSetupIntentのclient_secret
      const clientSecret = "<%= @client_secret %>";

      // 1) SetupIntentをconfirmしてPMを保存
      const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret, { payment_method: { card } });
      if (error) return alert(error.message);

      // 2) PM ID をサーバへ送ってサブスク作成
      const token = document.querySelector('meta[name="csrf-token"]').content;
      const res = await fetch("<%= cards_path %>", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
        body: JSON.stringify({ payment_method_id: setupIntent.payment_method })
      });

      if (res.redirected) window.location = res.url;
      else alert("登録に失敗しました");
    });
  })();
</script>
