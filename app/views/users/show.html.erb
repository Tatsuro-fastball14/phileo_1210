<hr style="margin:24px 0;">

<h2>購読ステータス</h2>

<%# ↓購読判定はあなたの実装に合わせて置き換えてOK %>
<% subscribed = (defined?(@subscription) && @subscription&.status == "active") ||
                (@user.respond_to?(:subscribed?) && @user.subscribed?) || true %>

<div id="unsubscribe-status" aria-live="polite" style="max-width:520px;margin:8px 0 12px;"></div>

<% if subscribed %>
  <div style="max-width:520px;position:relative;">
    <p style="margin:4px 0 12px;color:#444;">現在：<strong>有料プラン購読中</strong></p>

    <button id="cancel-btn"
            data-endpoint="<%= cancel_subscription_path %>"
            data-redirect="<%= cards_path %>"
            style="padding:10px 16px;border:0;border-radius:8px;background:#b42318;color:#fff;cursor:pointer;">
      購読を解約する
    </button>

    <div id="unsubscribe-loading" aria-hidden="true"
         style="display:none;position:absolute;inset:0;background:rgba(255,255,255,0.85);border-radius:8px;">
      <div role="status" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:80%;max-width:360px;text-align:center;">
        <div style="width:28px;height:28px;border:3px solid #999;border-top-color:transparent;border-radius:50%;margin:0 auto 10px;animation:spin .8s linear infinite;"></div>
        <div style="font-size:.95rem;color:#333;margin-bottom:8px;">解約処理中です…</div>
        <div style="height:6px;background:#eee;border-radius:99px;overflow:hidden;">
          <div style="height:100%;width:40%;background:#111;animation:indet 1.2s ease-in-out infinite;"></div>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <p style="margin:4px 0 0;color:#444;">現在：<strong>未購読</strong></p>
  <%= link_to "有料プランに登録する", new_card_path, class: "item-red-btn", style: "display:inline-block;margin-top:8px;" %>
<% end %>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes indet {
  0% { transform: translateX(-60%); width: 40%; }
  50% { transform: translateX(20%);  width: 60%; }
  100%{ transform: translateX(120%); width: 40%; }
}
</style>

<script>
(() => {
  const btn = document.getElementById("cancel-btn");
  if (!btn) return;

  const statusBox = document.getElementById("unsubscribe-status");
  const overlay   = document.getElementById("unsubscribe-loading");
  const endpoint  = btn.dataset.endpoint;
  const redirect  = btn.dataset.redirect;

  const showStatus = (msg, type="info") => {
    const theme = {
      info:  {bg:"#eaf4ff", bd:"#bcd9ff", fg:"#0b3d91"},
      ok:    {bg:"#edf9f0", bd:"#bde5c8", fg:"#1a7f37"},
      error: {bg:"#ffefef", bd:"#f5bcbc", fg:"#a40000"}
    }[type];
    statusBox.innerHTML =
      `<div style="padding:10px 12px;border:1px solid ${theme.bd};border-radius:8px;background:${theme.bg};color:${theme.fg};">${msg}</div>`;
  };

  const showLoading = () => {
    overlay.style.display = "block";
    overlay.setAttribute("aria-hidden", "false");
    btn.disabled = true;
    btn.style.opacity = .6;
    btn.style.cursor = "not-allowed";
    btn.textContent = "処理中…";
  };

  const hideLoading = () => {
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
    btn.disabled = false;
    btn.style.opacity = 1;
    btn.style.cursor = "pointer";
    btn.textContent = "購読を解約する";
  };

  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!confirm("本当に解約しますか？次回以降の請求は停止されます。")) return;

    showStatus("解約リクエストを送信しています…", "info");
    showLoading();

    try {
      const token = document.querySelector('meta[name="csrf-token"]')?.content;
      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { "X-CSRF-Token": token } : {})
        },
        body: JSON.stringify({ reason: "user_requested" })
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "解約に失敗しました。時間をおいて再度お試しください。");

      showStatus("解約が完了しました。ご利用ありがとうございました。", "ok");
      btn.textContent = "解約済み";
      btn.disabled = true;

      setTimeout(() => { window.location.href = json?.redirect_to || redirect || "/"; }, 1200);
    } catch (err) {
      console.error(err);
      showStatus(err.message || "解約に失敗しました。時間をおいて再度お試しください。", "error");
      hideLoading();
    }
  });
})();
</script>
